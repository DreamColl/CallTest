//
//  CallDirectoryHandler.m
//  CallKit
//
//  Created by 熊济源 on 2016/9/23.
//  Copyright © 2016年 xiong. All rights reserved.
//

#import "CallDirectoryHandler.h"

@interface CallDirectoryHandler () <CXCallDirectoryExtensionContextDelegate>
@end

@implementation CallDirectoryHandler

- (void)beginRequestWithExtensionContext:(CXCallDirectoryExtensionContext *)context {
    context.delegate = self;

    if (![self addBlockingPhoneNumbersToContext:context]) {
        NSLog(@"Unable to add blocking phone numbers");
        NSError *error = [NSError errorWithDomain:@"CallDirectoryHandler" code:1 userInfo:nil];
        [context cancelRequestWithError:error];
        return;
    }
    
    if (![self addIdentificationPhoneNumbersToContext:context]) {
        NSLog(@"Unable to add identification phone numbers");
        NSError *error = [NSError errorWithDomain:@"CallDirectoryHandler" code:2 userInfo:nil];
        [context cancelRequestWithError:error];
        return;
    }
    
    [context completeRequestWithCompletionHandler:nil];
}

- (BOOL)addBlockingPhoneNumbersToContext:(CXCallDirectoryExtensionContext *)context {
    // Retrieve phone numbers to block from data store. For optimal performance and memory usage when there are many phone numbers,
    // consider only loading a subset of numbers at a given time and using autorelease pool(s) to release objects allocated during each batch of numbers which are loaded.
    //
    // Numbers must be provided in numerically ascending order.
//    黑名单规则
//    1.当block和Identification有同样的号码时，黑名单优先
//    2.网上说当通讯录和黑名单有相同号码时，可以收到电话提示。但是经过测试，黑名单优先
//    3.黑名单内无号码，号码不为11位时，程序无法运行
    CXCallDirectoryPhoneNumber phoneNumbers[] = {8613601680499};
    NSUInteger count = (sizeof(phoneNumbers) / sizeof(CXCallDirectoryPhoneNumber));

    for (NSUInteger index = 0; index < count; index += 1) {
        CXCallDirectoryPhoneNumber phoneNumber = phoneNumbers[index];
        [context addBlockingEntryWithNextSequentialPhoneNumber:phoneNumber];
    }

    return YES;
}

- (BOOL)addIdentificationPhoneNumbersToContext:(CXCallDirectoryExtensionContext *)context {
    // Retrieve phone numbers to identify and their identification labels from data store. For optimal performance and memory usage when there are many phone numbers,
    // consider only loading a subset of numbers at a given time and using autorelease pool(s) to release objects allocated during each batch of numbers which are loaded.
    //
    // Numbers must be provided in numerically ascending order.
    //标记规则，
//    1.必须全部加国际区号如中国86，有一个号码没有区号，即无法运行。
//    2.如果一个区号都不加，则标记无效，无法识别
//    3.lables and phoneNumbers 必须一一对应，否则无法运行
//    4.标记单和通讯录有相同号码，通讯录优先
//    5.号码不能有+、-、空格
//    6.CXCallDirectoryPhoneNumber 有一个容量限制 INT64_MAX - 1 容纳90个电话号码左右
//    7.号码要求升序，同一个数组内只能有相同长度的号码。否则无法运行

//    1-20行中13个数字长度的号码，共396个
    CXCallDirectoryPhoneNumber phoneNumbers[] = { 8601052805276,8601052955399,8601053502058,8601053777893,8601053955299,8601056302054,8601056543724,8601058345752,8601059099235,8601080744100,8602029812172,8602037184322,8602061005144,8602061124231,8602062100786,8602066301532,8602066374808,8602081454851,8602081540327,8602081978831,8602083250871,8602085704564,8602086118543,8602089301886,8602120703553,8602122837339,8602122837475,8602131021572,8602131653028,8602135895809,8602137066542,8602137066546,8602137066549,8602151342861,8602151352460,8602151352470,8602151398734,8602151964812,8602155001207,8602155001311,8602155001385,8602155001497,8602160590570,8602160590632,8602160651294,8602161479737,8602161979584,8602166194025,8602166194100,8602166194577,8602180284846,8602180318918,8602195093015,8602196833132,8602196833214,8602196833837,8602196833954,8602260125746,8602260400530,8602260400698,8602260400723,8602260400765,8602462738900,8602589623442,8602751005586,8602758904321,8602759420861,8602862979515,8602863157790,8602867691287,8602867739401,8602867739419,8602868073093,8602868073095,8602868369223,8602868369226,8602868651455,8602868865050,8602868957396,8602869927815,8603195254718,8603936226000,8605333151719,8605589506520,8605923303407,8607103727013,8607722477458,8607722477822,8607722477897,8607725361073,8613001006051,8613004155401,8613024379655,8613037929001,8613038875110,8613039187052,8613046205253,8613084936265,8613088332075,8613096464695,8613102936776,8613103494016,8613120605052,8613120879487,8613120989272,8613121840449,8613128690989,8613129709868,8613139576901,8613142039597,8613145395750,8613149649678,8613177988809,8613180754675,8613191031666,8613225028943,8613229214779,8613237411770,8613250795234,8613256850357,8613272082622,8613276067884,8613278876139,8613289950291,8613321980752,8613327887479,8613348854839,8613364110137,8613366114440,8613366754023,8613373326856,8613387367308,8613389143760,8613398617950,8613399662512,8613408013076,8613432845986,8613435736968,8613471523370,8613487023121,8613504250115,8613517383181,8613522067931,8613526794202,8613557489598,8613559088368,8613561722426,8613566939362,8613576361573,8613587019979,8613602096628,8613605608803,8613606699140,8613612644707,8613620223463,8613627212052,8613635990382,8613648942899,8613679573222,8613691248026,8613703301618,8613726426758,8613754988502,8613761919539,8613768113644,8613769202853,8613776176073,8613786655131,8613788295826,8613790707891,8613816419254,8613825369489,8613830895107,8613845758839,8613855171909,8613866372415,8613891180532,8613897623783,8613899267603,8613908685943,8613909302820,8613909987091,8613926456194,8613955069767,8613963909084,8613968826957,8613971197056,8613983030520,8613987802499,8613988574965,8613990877137,8614792988888,8615001453010,8615010107790,8615011403855,8615025844492,8615041763462,8615057591620,8615057678325,8615061133944,8615064674089,8615068263070,8615069816179,8615075506672,8615085679255,8615085880325,8615087617682,8615087769425,8615134679818,8615144864221,8615157228064,8615158670276,8615168763952,8615171387776,8615185751162,8615186108785,8615189031383,8615203646599,8615208539968,8615208810116,8615223618222,8615237063624,8615238110445,8615241122397,8615258131653,8615262583761,8615275777657,8615283543053,8615285836227,8615285888090,8615289669273,8615290438395,8615293594471,8615293885316,8615295792805,8615298949632,8615330465138,8615378802686,8615389641139,8615391308666,8615399558826,8615514561327,8615515836565,8615519907404,8615527574679,8615528181072,8615535294722,8615537322231,8615537930288,8615562195158,8615569075902,8615575147965,8615589838777,8615600858088,8615603675181,8615616754453,8615626122443,8615666839799,8615698365678,8615699139789,8615710400381,8615710402017,8615732811005,8615737503766,8615757825339,8615806584888,8615807358209,8615810169075,8615815848361,8615822154179,8615824013005,8615829163856,8615829170773,8615852174327,8615862282991,8615868275289,8615869652858,8615872000307,8615879467785,8615887379636,8615887701120,8615889786676,8615891375775,8615899763768,8615901599550,8615902816551,8615905376220,8615908971840,8615912888406,8615917637091,8615922200842,8615926288453,8615929417955,8615932776861,8615934600809,8615957761889,8615972778220,8615974438637,8615983530562,8615985988690,8615986017774,8615991293055,8617130624367,8617130624405,8617131516799,8617131518483,8617167749485,8617189485123,8617198683357,8617199810118,8617786732939,8617820343553,8617839519802,8618016048462,8618017095837,8618018615581,8618019064420,8618032450352,8618046621959,8618055802257,8618078495371,8618085068909,8618110272789,8618111313669,8618132087125,8618173316467,8618201207414,8618205996891,8618219357915,8618246436546,8618252286789,8618257689969,8618261372129,8618268283228,8618268867467,8618277662455,8618290054609,8618301035993,8618308318637,8618316533182,8618326601817,8618331227911,8618362185197,8618365237007,8618365846161,8618367495229,8618368820868,8618386376959,8618396908075,8618397195186,8618455847512,8618501024470,8618545840701,8618581739896,8618604492138,8618606208859,8618623233296,8618647113735,8618656766789,8618662290309,8618665491889,8618671500677,8618673497652,8618680024206,8618685856739,8618691091257,8618724299786,8618744445963,8618772218969,8618786082830,8618799169831,8618804570665,8618808937839,8618817112209,8618817112218,8618817112249,8618828020881,8618834913970,8618841912648,8618847129344,8618847129433,8618850006877,8618858537540,8618862169287,8618867720943,8618873673228,8618931275205,8618963883324,8618982104822,8618982963422,8618989032000,8618996342821,8619093767985,8645056721406,8685251044948,8688829848863 };
    
    NSUInteger count = (sizeof(phoneNumbers) / sizeof(CXCallDirectoryPhoneNumber));

    for (NSUInteger i = 0; i < count; i ++) {
        CXCallDirectoryPhoneNumber phoneNumber = phoneNumbers[i];
        NSString *label = @"骚扰电话";
        [context addIdentificationEntryWithNextSequentialPhoneNumber:phoneNumber label:label];
    }

    return YES;
}

#pragma mark - CXCallDirectoryExtensionContextDelegate

- (void)requestFailedForExtensionContext:(CXCallDirectoryExtensionContext *)extensionContext withError:(NSError *)error {
    // An error occurred while adding blocking or identification entries, check the NSError for details.
    // For Call Directory error codes, see the CXErrorCodeCallDirectoryManagerError enum in <CallKit/CXError.h>.
    //
    // This may be used to store the error details in a location accessible by the extension's containing app, so that the
    // app may be notified about errors which occured while loading data even if the request to load data was initiated by
    // the user in Settings instead of via the app itself.
}

@end
